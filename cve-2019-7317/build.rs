use std::{
    env, fs,
    path::{Path, PathBuf},
    process::Command,
};

fn main() {
    // STEP 0 - Set up the compile environment

    let target_dir = Path::new("target");

    if !target_dir.is_dir() {
        fs::create_dir(target_dir).expect("could not create target directory");
    }

    env::set_current_dir("target").expect("could not cd to target");

    // STEP 1 - Download and extract libpng

    let libpng_version = String::from("1.6.36");
    let libpng_directory = format!("libpng-{libpng_version}");
    let libpng_archive = format!("{libpng_directory}.tar.xz");
    let libpng_download_url = format!("https://sourceforge.net/projects/libpng/files/libpng16/{libpng_version}/{libpng_archive}/download");

    Command::new("wget")
        .args(["-O", &libpng_archive, &libpng_download_url])
        .status()
        .expect("failed to fetch libpng");

    Command::new("tar")
        .args(["xvf", &libpng_archive])
        .status()
        .expect("could not unpack libpng");

    env::set_current_dir(&libpng_directory).expect("could not cd to libpng");

    // STEP 2 - Compile libpng with instrumentation

    let afl_path = env::var("AFL_PATH").expect("need AFL_PATH to continue");
    let afl_cc = Path::new(&afl_path).join("afl-cc");
    let ld_path = Command::new("command")
        .args(["-v", "lld"])
        .output()
        .expect("could not find lld");
    let ld = String::from_utf8(ld_path.stdout).expect("could not parse which ld output");

    Command::new("./configure")
        .env("AFL_DEBUG", "1")
        .env("AFL_CC_COMPILER", "LLVM")
        // .env("AFL_USE_ASAN", "1")
        // .env("CFLAGS", "-fsanitize=address -O2 -g")
        // .env("LDFLAGS", "-fsanitize=address")
        .env("CFLAGS", "-O2 -g")
        .env("LDFLAGS", "-lz")
        .env("CC", afl_cc)
        .env("LD", ld.trim())
        .args(["--disable-shared", "--enable-static"])
        .status()
        .expect("failed configure");

    Command::new("make").status().expect("make failed");

    // Step 3 - Generate rust bindings from the headers

    env::set_current_dir("../../").expect("could not cd to project root");

    let output_path = PathBuf::from(env::var("OUT_DIR").unwrap());

    let bindings = bindgen::Builder::default()
        .header("wrapper.h")
        .parse_callbacks(Box::new(bindgen::CargoCallbacks::new()))
        .generate()
        .expect("unable to generate bindings");

    bindings
        .write_to_file(output_path.join("bindings.rs"))
        .expect("could not write bindings");

    println!("cargo::rerun-if-changed=build.rs");
    println!("cargo::rerun-if-changed=wrapper.h");
    println!("cargo:rustc-link-search=native=target/{libpng_directory}/.libs");
    println!("cargo:rustc-link-lib=static=png16");
    println!("cargo:rustc-link-lib=static=z");
}
